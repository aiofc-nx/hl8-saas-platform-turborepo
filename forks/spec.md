# Feature Specification: SAAS Core 核心业务模块实现

**Feature Branch**: `001-saas-core-implementation`  
**Created**: 2025-10-08  
**Status**: Draft

## User Scenarios & Testing

### User Story 1 - 租户管理核心功能 (Priority: P1)

作为平台管理员，我需要创建和管理不同类型的租户，以便为客户提供多租户SAAS服务。

**Why this priority**: 租户是整个SAAS平台的核心基础，没有租户管理就无法提供任何业务功能。这是MVP的绝对前提。

**Independent Test**: 可以通过创建一个租户（任意类型）、配置其资源限制、查看租户状态、完成租户生命周期管理来独立测试，验证数据隔离和配置生效。

**Acceptance Scenarios**:

1. **Given** 平台管理员登录系统，**When** 创建一个新的免费租户（包含租户代码、名称、域名），**Then** 系统创建租户、分配默认配置（5用户/100MB/1组织）、状态设为试用、发送创建成功通知
2. **Given** 租户已创建，**When** 查看租户详情，**Then** 显示租户类型、资源配置、使用情况、状态、创建时间等完整信息
3. **Given** 免费租户达到用户限制（5个用户），**When** 尝试添加第6个用户，**Then** 系统拒绝并提示已达配额限制，建议升级到基础租户
4. **Given** 租户申请升级到基础租户，**When** 平台管理员处理升级申请，**Then** 系统更新租户类型、调整资源限制（50用户/1GB/2组织）、记录升级历史

---

### User Story 2 - 用户身份和认证 (Priority: P1)

作为平台用户，我需要注册账号、登录系统、管理个人信息，以便使用平台提供的服务。

**Why this priority**: 用户身份是访问系统的基础，与租户管理同等重要，两者共同构成MVP的核心。

**Independent Test**: 可以通过注册新用户、邮箱验证、登录、修改个人信息、查看账户状态来独立测试，无需依赖其他功能。

**Acceptance Scenarios**:

1. **Given** 访问平台注册页面，**When** 填写基本信息（用户名、邮箱、密码、手机号）并提交，**Then** 系统创建平台用户、发送邮箱验证、状态设为待激活
2. **Given** 用户收到验证邮件，**When** 点击验证链接，**Then** 系统激活账户、状态变为活跃、用户可登录
3. **Given** 活跃用户输入正确的用户名和密码，**When** 点击登录，**Then** 系统验证身份、创建会话、跳转到用户工作台
4. **Given** 用户登录后，**When** 申请创建租户，**Then** 系统默认创建免费租户、用户成为租户管理员、自动创建默认组织和根部门

---

### User Story 3 - 组织架构管理 (Priority: P2)

作为租户管理员，我需要创建和管理组织及部门结构，以便支持企业的组织架构管理。

**Why this priority**: 组织架构是企业管理的核心，但可以在有了租户和用户之后再实现，不阻塞基础功能。

**Independent Test**: 可以在已有租户的基础上，创建组织（横向）和部门（纵向）、设置层级关系、分配用户来独立测试。

**Acceptance Scenarios**:

1. **Given** 租户管理员登录，**When** 创建新组织（如"技术委员会"），**Then** 系统创建横向组织、设置类型为专业委员会、状态为活跃
2. **Given** 组织已创建，**When** 在组织下创建一级部门（如"技术部"），**Then** 系统创建根部门、设置部门层级为LEVEL_1、关联到组织
3. **Given** 一级部门已创建，**When** 创建二级部门（如"前端组"），**Then** 系统创建子部门、设置层级为LEVEL_2、建立父子关系
4. **Given** 部门结构已建立，**When** 将用户分配到部门，**Then** 系统记录用户部门关系、用户可查看部门信息、支持兼职（多部门）

---

### User Story 4 - 角色和权限管理 (Priority: P2)

作为租户管理员，我需要定义角色和分配权限，以便实现精细化的访问控制。

**Why this priority**: 权限管理对安全性很重要，但可以在基础功能之后实现，初期可使用简单的管理员/普通用户区分。

**Independent Test**: 可以创建角色（如部门经理）、分配权限、将角色赋予用户、验证用户操作权限来独立测试。

**Acceptance Scenarios**:

1. **Given** 租户管理员登录，**When** 创建新角色（如"部门经理"），**Then** 系统创建角色、设置角色层级为部门级、状态为活跃
2. **Given** 角色已创建，**When** 为角色分配权限（如"查看部门用户"、"编辑部门信息"），**Then** 系统记录角色权限关系
3. **Given** 角色和权限已配置，**When** 将角色赋予用户，**Then** 用户获得角色权限、可执行被授权的操作
4. **Given** 用户拥有某角色，**When** 尝试执行未授权操作（如删除租户），**Then** 系统拒绝操作并提示权限不足

---

### User Story 5 - 数据隔离和安全 (Priority: P2)

作为平台架构师，我需要实现严格的数据隔离策略，以便确保租户数据安全和隐私。

**Why this priority**: 数据隔离对SAAS平台很重要，但实现层面可以先采用简单策略（如行级隔离），后续优化。

**Independent Test**: 可以创建多个租户、在每个租户中创建数据、验证租户A无法访问租户B的数据来独立测试。

**Acceptance Scenarios**:

1. **Given** 两个租户（租户A和租户B）已创建，**When** 租户A用户尝试查询数据，**Then** 系统只返回租户A的数据、自动过滤其他租户数据
2. **Given** 租户配置数据库级隔离，**When** 系统为租户创建独立数据库Schema，**Then** 物理层面实现数据隔离
3. **Given** 用户跨租户切换（如用户同时属于租户A和租户B），**When** 用户选择切换到租户B，**Then** 系统更新租户上下文、只显示租户B的数据和功能
4. **Given** 平台管理员查看系统数据，**When** 访问审计日志，**Then** 可以看到所有租户的操作记录、但数据已脱敏

---

### User Story 6 - 租户升级和配置管理 (Priority: P3)

作为租户管理员，我需要申请租户升级和调整配置，以便满足业务增长需求。

**Why this priority**: 租户升级是商业功能，不阻塞基础使用，可以在核心功能稳定后实现。

**Independent Test**: 可以提交升级申请、平台管理员审核、执行升级、验证新配置生效来独立测试。

**Acceptance Scenarios**:

1. **Given** 免费租户使用一段时间后，**When** 租户管理员申请升级到基础租户，**Then** 系统记录升级申请、通知平台管理员审核
2. **Given** 平台管理员收到升级申请，**When** 审核通过并执行升级，**Then** 系统更新租户类型、调整资源配额、保留现有数据
3. **Given** 租户已升级，**When** 查看租户配置，**Then** 显示新的资源限制和功能权限
4. **Given** 企业租户需要更多组织数量，**When** 申请定制配置，**Then** 平台管理员可单独调整配额、不限于标准套餐

---

### User Story 7 - 平台监控和运营 (Priority: P3)

作为平台管理员，我需要监控平台运行状况和租户使用情况，以便及时发现问题和优化资源。

**Why this priority**: 监控运营是平台成熟后的需求，初期可以通过简单的日志和手动检查来管理。

**Independent Test**: 可以访问监控仪表板、查看租户统计、设置告警规则、接收通知来独立测试。

**Acceptance Scenarios**:

1. **Given** 平台管理员登录，**When** 访问监控仪表板，**Then** 显示平台用户总数、活跃租户数、资源使用情况、系统性能指标
2. **Given** 查看租户列表，**When** 筛选即将到期的试用租户，**Then** 显示试用期剩余天数、提示需要跟进转化
3. **Given** 设置告警规则（如某租户API调用超限），**When** 触发告警条件，**Then** 系统发送通知给平台管理员
4. **Given** 租户资源使用异常（如存储突增），**When** 查看详细报告，**Then** 显示使用趋势图、异常原因分析、优化建议

---

### Edge Cases

- **租户代码冲突**：当尝试创建租户代码已存在的租户时，系统应拒绝并提示选择其他代码
- **超出资源限制**：当租户达到用户/存储/组织限制时，系统应阻止继续添加并友好提示升级
- **部门层级超限**：当尝试创建超过配置层级的部门时，系统应拒绝并提示当前层级限制
- **用户多租户冲突**：当用户同时属于多个租户时，系统应明确当前租户上下文，避免数据混淆
- **权限继承冲突**：当用户拥有多个角色且权限有冲突时，系统应按照优先级合并权限
- **租户降级场景**：当租户从高级降级到低级时，如果现有数据超出新配额（如用户数），系统应如何处理（只读访问 vs 强制删除）
- **组织删除影响**：删除组织时，其下属部门和用户关系如何处理（级联删除 vs 移动到默认组织）
- **用户注销影响**：用户注销时，其创建的租户、组织、部门应如何处理（转移所有权 vs 限制注销）

## Requirements

### Functional Requirements

#### 租户管理

- **FR-001**: 系统必须支持创建五种租户类型（FREE/BASIC/PROFESSIONAL/ENTERPRISE/CUSTOM）
- **FR-002**: 系统必须为每种租户类型自动分配默认配置（用户数、存储空间、组织数量）
- **FR-003**: 系统必须验证租户代码和域名的唯一性
- **FR-004**: 系统必须支持租户状态管理（试用/活跃/暂停/过期/已删除）
- **FR-005**: 系统必须支持租户升级和降级，并保留现有数据
- **FR-006**: 系统必须实现租户数据隔离，默认采用行级隔离策略
- **FR-007**: 系统必须支持为企业租户配置数据库级或Schema级隔离

#### 用户管理

- **FR-008**: 系统必须支持用户注册、邮箱验证、激活流程
- **FR-009**: 系统必须支持用户登录认证（用户名密码方式）
- **FR-010**: 系统必须支持用户状态管理（待激活/活跃/禁用/锁定/过期/已删除）
- **FR-011**: 系统必须支持用户创建租户并自动成为租户管理员
- **FR-012**: 系统必须支持用户同时属于多个租户，并可切换租户上下文
- **FR-013**: 系统必须记录用户的注册信息、操作历史、权限变更

#### 组织架构管理

- **FR-014**: 系统必须支持创建横向组织（专业委员会、项目管理团队、质量控制小组、绩效管理小组等）
- **FR-015**: 系统必须支持创建纵向部门，支持8层以上的多级嵌套
- **FR-016**: 系统必须为每个租户自动创建默认组织和根部门
- **FR-017**: 系统必须支持部门的父子关系管理和层级查询
- **FR-018**: 系统必须支持用户分配到组织和部门，支持兼职（多组织/多部门）
- **FR-019**: 系统必须根据租户类型限制组织数量（免费1个、基础2个、专业10个、企业100个、定制无限）

#### 角色和权限管理

- **FR-020**: 系统必须支持创建多层级角色（平台级/租户级/组织级/部门级）
- **FR-021**: 系统必须支持为角色分配细粒度权限
- **FR-022**: 系统必须支持基于角色的访问控制（RBAC）
- **FR-023**: 系统必须支持权限继承机制（上级权限包含下级权限）
- **FR-024**: 系统必须在用户执行操作前验证权限
- **FR-025**: 系统必须记录权限分配和变更的审计日志

#### 数据隔离和安全

- **FR-026**: 系统必须确保租户间数据完全隔离，一个租户不能访问其他租户的数据
- **FR-027**: 系统必须在所有数据查询中自动添加租户上下文过滤
- **FR-028**: 系统必须支持租户级别的备份和恢复
- **FR-029**: 系统必须对敏感数据进行加密存储（如密码、令牌）
- **FR-030**: 系统必须记录所有数据访问的审计日志，包括操作者、时间、操作类型

#### 资源配额管理

- **FR-031**: 系统必须在用户数达到租户配额时阻止添加新用户
- **FR-032**: 系统必须在存储空间达到租户配额时阻止上传新文件
- **FR-033**: 系统必须在组织数达到租户配额时阻止创建新组织
- **FR-034**: 系统必须提供资源使用情况的实时查询
- **FR-035**: 系统必须在资源接近配额时发送预警通知（如达到80%）

#### 平台监控和运营

- **FR-036**: 系统必须提供平台管理员监控仪表板，展示关键指标
- **FR-037**: 系统必须支持查询和统计所有租户的状态和使用情况
- **FR-038**: 系统必须支持设置告警规则和自动通知
- **FR-039**: 系统必须记录系统性能指标和错误日志
- **FR-040**: 系统必须提供租户健康度评估和优化建议

### Key Entities

- **平台 (Platform)**: SAAS服务提供商，管理所有租户和平台级用户
- **租户 (Tenant)**: 独立客户单位，拥有独立的数据空间和配置环境，类型包括FREE/BASIC/PROFESSIONAL/ENTERPRISE/CUSTOM
- **组织 (Organization)**: 租户内的横向管理单位，负责特定职能管理，类型包括专业委员会、项目管理团队等
- **部门 (Department)**: 组织内的纵向管理机构，具有明确的层级关系，支持8层以上嵌套
- **用户 (User)**: 系统使用者，首先属于平台，可被分配到租户、组织、部门
- **角色 (Role)**: 权限集合，分为平台级、租户级、组织级、部门级四个层级
- **权限 (Permission)**: 细粒度的操作许可，控制用户可执行的操作
- **租户配置 (TenantConfiguration)**: 租户的资源配置，包括用户数限制、存储限制、组织数限制等
- **数据隔离策略 (IsolationStrategy)**: 租户数据隔离的实现方式，包括行级/数据库级/Schema级/应用级

## Success Criteria

### Measurable Outcomes

- **SC-001**: 平台管理员可以在3分钟内完成新租户创建，包括类型选择、配置分配、验证完成
- **SC-002**: 新用户可以在2分钟内完成注册、邮箱验证、创建租户的完整流程
- **SC-003**: 租户管理员可以在5分钟内完成组织和部门结构的初始化（至少1个组织、3级部门）
- **SC-004**: 系统支持同时管理1000个活跃租户，每个租户包含平均100个用户
- **SC-005**: 租户数据查询响应时间在1秒内，即使数据库中存在多个租户的混合数据
- **SC-006**: 用户切换租户上下文的操作在500毫秒内完成，包括权限重新加载
- **SC-007**: 系统可以准确阻止100%的跨租户数据访问尝试，无数据泄露
- **SC-008**: 租户资源配额检查准确率100%，不会出现超配或误拦截
- **SC-009**: 权限验证响应时间在100毫秒内，不影响用户操作体验
- **SC-010**: 平台监控仪表板加载时间在2秒内，实时刷新间隔不超过30秒
- **SC-011**: 租户升级操作在5分钟内完成，数据零丢失，服务中断时间少于10秒
- **SC-012**: 新租户的试用转化率提升20%，通过及时的资源预警和升级引导
- **SC-013**: 系统可以支持最深10层的部门嵌套，查询和展示性能不降级
- **SC-014**: 审计日志记录100%的敏感操作，日志查询响应时间在3秒内

## Assumptions

1. **认证方式**: 初期采用用户名密码认证，OAuth和SSO将在后续版本中实现
2. **数据库选择**: 使用PostgreSQL作为主数据库，使用MikroORM作为ORM
3. **默认隔离策略**: 所有租户默认使用行级隔离策略，企业租户可选择升级到数据库级隔离
4. **部门层级限制**: 虽然技术上支持无限层级，但建议在业务上限制在8-10层以内，避免管理复杂度过高
5. **资源配额检查**: 资源配额检查在应用层实现，不依赖数据库约束
6. **多租户上下文**: 使用JWT或Session来存储当前租户上下文，用户可通过UI切换
7. **权限缓存**: 用户权限信息可缓存30分钟，权限变更后需要等待或强制刷新
8. **试用期限**: 免费租户默认无试用期限，付费租户试用期为30天
9. **数据保留**: 租户删除后，数据保留30天用于恢复，之后永久删除
10. **邮件服务**: 依赖外部邮件服务提供商发送验证邮件和通知

## Dependencies

1. **@hl8/hybrid-archi**: 必须依赖此模块提供的架构基础、基础设施服务
2. **统一业务术语**: 必须遵循 `docs/definition-of-terms.mdc` 中定义的术语规范
3. **邮件服务**: 需要集成邮件服务提供商（如SendGrid、阿里云邮件）用于发送验证和通知邮件
4. **缓存服务**: 需要Redis用于缓存用户权限、租户配置等高频访问数据
5. **消息队列**: 需要消息队列（RabbitMQ或Kafka）用于异步处理租户创建、升级等操作
6. **监控服务**: 需要集成监控工具（如Prometheus）用于收集系统性能指标

## Constraints

1. **数据库性能**: 单个租户的用户查询必须在1秒内返回，即使租户有10,000个用户
2. **并发限制**: 系统需要支持至少100个并发的租户创建/升级操作
3. **存储扩展**: 租户存储空间需要支持动态扩展，不能硬编码存储路径
4. **向后兼容**: 租户类型和配置变更必须向后兼容，不能破坏已有租户的功能
5. **多语言**: 虽然当前只支持中文，但数据模型必须支持未来的多语言扩展
6. **审计合规**: 所有敏感操作必须记录审计日志，保留至少1年用于合规审查

## Out of Scope

以下功能不在本次实现范围内，将在后续版本中考虑：

1. **OAuth和SSO认证**: 当前只实现用户名密码认证
2. **微信/钉钉集成**: 第三方平台集成将在后续版本实现
3. **移动端App**: 当前只实现Web端，移动端将独立规划
4. **多语言支持**: 当前只支持中文，国际化将在后续版本实现
5. **租户间协作**: 跨租户的数据共享和协作功能不在此范围
6. **高级分析报表**: 当前只提供基础的监控指标，复杂报表功能将独立规划
7. **AI智能推荐**: 智能功能（如租户配置推荐、异常检测）将在后续版本实现
8. **自定义工作流**: 租户自定义业务流程功能将独立规划

## Implementation Status

### 已完成的核心功能

#### 租户管理

- ✅ 租户类型定义（FREE/BASIC/PROFESSIONAL/ENTERPRISE/CUSTOM）
- ✅ 租户配额系统（用户数、存储空间、组织数量限制）
- ✅ 租户生命周期管理（创建、升级、降级、激活、暂停）
- ✅ 租户创建用例（验证唯一性、配额分配）
- ✅ 租户升级/降级用例
- ✅ 租户激活用例

#### 基础架构

- ✅ 事件溯源基础设施
- ✅ CQRS 总线集成
- ✅ 租户过滤器（数据隔离）
- ✅ 配置管理系统
- ✅ 模块化设计

### 待实现的功能

#### 用户管理

- ⏳ 用户注册和认证流程
- ⏳ 用户状态管理
- ⏳ 多租户用户关联

#### 组织架构管理

- ⏳ 组织创建和管理
- ⏳ 部门层级结构
- ⏳ 用户组织分配

#### 权限管理

- ⏳ 角色定义和分配
- ⏳ 权限控制
- ⏳ 基于角色的访问控制（RBAC）

#### 数据隔离

- ⏳ 行级隔离实现
- ⏳ 数据库级隔离支持
- ⏳ 跨租户数据访问防护

#### 监控和运营

- ⏳ 平台监控仪表板
- ⏳ 租户使用情况统计
- ⏳ 告警和通知系统

## Implementation Roadmap

### Phase 1: 核心租户管理 (已完成)

- ✅ 租户类型和配额系统
- ✅ 租户生命周期管理
- ✅ 基础事件溯源架构
- ✅ CQRS 总线集成

### Phase 2: 用户认证与管理 (进行中)

- ⏳ 用户注册和邮箱验证
- ⏳ 用户登录认证
- ⏳ 用户状态管理
- ⏳ 多租户用户关联

### Phase 3: 组织架构 (计划中)

- ⏳ 组织创建和管理
- ⏳ 部门层级结构
- ⏳ 用户组织分配
- ⏳ 兼职支持

### Phase 4: 权限控制 (计划中)

- ⏳ 角色定义和管理
- ⏳ 权限分配
- ⏳ RBAC 实现
- ⏳ 权限继承

### Phase 5: 数据隔离与安全 (计划中)

- ⏳ 行级数据隔离
- ⏳ 数据库级隔离
- ⏳ 审计日志
- ⏳ 数据加密

### Phase 6: 监控与运营 (计划中)

- ⏳ 平台监控仪表板
- ⏳ 租户使用统计
- ⏳ 告警系统
- ⏳ 性能监控

## Next Steps

### 优先级 P1 (立即执行)

1. **完善用户管理模块**
   - 实现用户注册和认证用例
   - 添加用户状态管理
   - 集成邮箱验证服务

2. **数据库配置完善**
   - 创建数据库连接配置
   - 实现租户数据隔离
   - 添加数据迁移脚本

### 优先级 P2 (短期计划)

1. **组织架构实现**
   - 创建组织和部门实体
   - 实现层级关系管理
   - 添加用户分配功能

2. **权限系统基础**
   - 定义角色和权限模型
   - 实现基础权限检查
   - 添加权限分配功能

### 优先级 P3 (中期计划)

1. **监控和运营功能**
   - 实现监控仪表板
   - 添加使用情况统计
   - 创建告警机制

2. **性能优化**
   - 实现缓存策略
   - 优化查询性能
   - 添加批量操作支持
