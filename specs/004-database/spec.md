# Feature Specification: Database 连接管理模块

**Feature Branch**: `004-database`  
**Created**: 2025-10-13  
**Status**: Draft  
**Input**: User description: "创建兼容现有基础设施的database连接管理模块"

<!--
  重要提示：在编写需求规范时，请使用 `docs/definition-of-terms.mdc` 中定义的统一术语，
  确保业务需求描述与技术实现使用相同的领域语言（Ubiquitous Language）。
  核心术语包括：Platform（平台）、Tenant（租户）、Organization（组织）、Department（部门）、User（用户）等。
-->

## 背景和目标

本项目需要一个统一的数据库连接管理模块，作为平台的基础设施层，为所有应用提供可靠的数据库访问能力。该模块必须与现有的基础设施库（@hl8/config、@hl8/exceptions、@hl8/nestjs-isolation、@hl8/caching）完全兼容，并支持平台的多租户数据隔离要求。

旧版本的 database 模块存在架构不匹配问题（CommonJS vs ES Module、依赖包不存在），需要重新设计和实现。

## User Scenarios & Testing _(mandatory)_

### User Story 1 - 应用启动建立数据库连接 (Priority: P1)

作为应用开发者，我需要在应用启动时自动建立数据库连接，以便应用能够正常访问数据。

**Why this priority**: 这是最基础的功能，没有数据库连接，任何数据操作都无法进行。这是整个模块的核心价值。

**Independent Test**: 可以通过启动一个最小化的 NestJS 应用，导入 database 模块，然后验证连接是否成功建立来独立测试。

**Acceptance Scenarios**:

1. **Given** 应用配置了有效的数据库连接参数，**When** 应用启动时，**Then** 数据库连接自动建立成功
2. **Given** 应用配置了无效的数据库连接参数，**When** 应用启动时，**Then** 抛出清晰的连接错误异常，应用启动失败
3. **Given** 数据库服务不可用，**When** 应用启动时，**Then** 在配置的超时时间内重试连接，超时后抛出异常
4. **Given** 应用正在运行，**When** 数据库连接意外断开，**Then** 系统记录错误日志并尝试自动重连

---

### User Story 2 - 多租户数据隔离 (Priority: P2)

作为 SAAS 平台管理员，我需要确保每个租户的数据被完全隔离，以满足数据安全和合规要求。

**Why this priority**: 多租户数据隔离是 SAAS 平台的核心安全要求，必须在基础设施层面保证。这是平台的关键特性。

**Independent Test**: 可以通过创建两个租户，在各自的隔离上下文中执行数据操作，然后验证租户 A 无法访问租户 B 的数据来独立测试。

**Acceptance Scenarios**:

1. **Given** 系统配置了 5 级数据隔离策略，**When** 租户 A 请求数据时，**Then** 只能访问属于租户 A 的数据
2. **Given** 当前隔离上下文为租户 A，**When** 尝试执行数据操作时，**Then** 所有操作自动限定在租户 A 的数据范围内
3. **Given** 请求中缺少隔离上下文信息，**When** 尝试访问需要隔离的数据时，**Then** 系统拒绝访问并返回明确的错误信息
4. **Given** 系统需要切换租户上下文，**When** 切换后执行数据操作，**Then** 操作在新的租户上下文中正确执行

---

### User Story 3 - 事务管理 (Priority: P2)

作为应用开发者，我需要简便的事务管理机制，确保多个数据操作的原子性。

**Why this priority**: 事务是保证数据一致性的关键机制，必须易用且可靠。

**Independent Test**: 可以通过编写一个包含多个数据库操作的业务逻辑，在中途抛出异常，验证是否所有操作都被回滚来独立测试。

**Acceptance Scenarios**:

1. **Given** 开发者使用事务装饰器标记方法，**When** 方法执行成功时，**Then** 所有数据操作自动提交
2. **Given** 事务中的某个操作失败，**When** 抛出异常时，**Then** 所有已执行的操作自动回滚
3. **Given** 开发者手动管理事务，**When** 显式调用提交或回滚时，**Then** 系统按指令执行相应操作
4. **Given** 多个嵌套的事务方法，**When** 任一层级失败时，**Then** 整个事务链都被回滚

---

### User Story 4 - 连接池管理 (Priority: P3)

作为系统管理员，我需要合理的连接池管理，确保在高并发场景下数据库连接得到有效利用。

**Why this priority**: 连接池优化对性能很重要，但不是功能性的核心需求。

**Independent Test**: 可以通过模拟大量并发请求，监控连接池使用情况，验证连接复用和释放是否正常来独立测试。

**Acceptance Scenarios**:

1. **Given** 系统配置了最大连接数，**When** 并发请求超过限制时，**Then** 新请求等待可用连接而不是失败
2. **Given** 连接空闲超过配置的时间，**When** 达到空闲超时时，**Then** 连接被自动关闭释放资源
3. **Given** 数据库操作完成，**When** 连接归还到池中时，**Then** 连接状态被重置并可供其他请求使用
4. **Given** 连接池状态异常，**When** 检测到不健康的连接时，**Then** 系统自动移除并创建新连接

---

### User Story 5 - 监控和健康检查 (Priority: P4)

作为运维人员，我需要实时监控数据库连接状态和性能指标，以便及时发现和处理问题。

**Why this priority**: 监控是运维的必需功能，但不影响核心业务逻辑。

**Independent Test**: 可以通过调用健康检查端点，验证返回的监控数据是否准确来独立测试。

**Acceptance Scenarios**:

1. **Given** 应用正在运行，**When** 调用健康检查接口时，**Then** 返回数据库连接状态（正常/异常）
2. **Given** 系统记录了慢查询，**When** 查询慢查询列表时，**Then** 返回超过阈值的查询及其执行时间
3. **Given** 需要查看连接池使用情况，**When** 调用统计接口时，**Then** 返回当前活动连接数、空闲连接数等指标
4. **Given** 多租户环境，**When** 查询各租户连接统计时，**Then** 返回每个租户的独立连接数据

---

### Edge Cases

- 当数据库连接在事务执行过程中断开时，系统如何处理？应该抛出异常并记录详细错误，让上层应用能够感知并采取补救措施。
- 当同一个租户的并发请求超过单个租户的连接限制时，系统如何响应？应该排队等待或拒绝新请求，并返回明确的资源不足错误。
- 当隔离上下文信息不完整（例如只有租户 ID，缺少组织或部门信息）时，系统如何处理？应该根据数据隔离级别要求，如果缺少必需的上下文信息则拒绝访问。
- 当配置了错误的连接参数（如错误的数据库名、用户名、密码）时，系统如何快速失败并提供清晰的错误信息？应该在启动时验证配置并立即报错，不允许应用进入不可用状态。

## Requirements _(mandatory)_

### Functional Requirements

#### 连接管理

- **FR-001**: 模块必须支持在应用启动时自动建立数据库主连接
- **FR-002**: 模块必须支持配置连接参数（主机、端口、数据库名、用户名、密码等）
- **FR-003**: 模块必须在连接失败时提供清晰的错误信息，包括失败原因和建议的修复方法
- **FR-004**: 模块必须支持连接健康检查，能够检测连接是否可用
- **FR-005**: 模块必须支持连接超时配置，避免无限期等待
- **FR-006**: 模块必须在检测到连接断开时记录日志并尝试重连

#### 多租户隔离

- **FR-007**: 模块必须集成 @hl8/nestjs-isolation 提供的隔离上下文（IsolationContext）
- **FR-008**: 模块必须支持基于隔离上下文自动过滤数据，确保租户只能访问自己的数据
- **FR-009**: 模块必须在缺少必需的隔离上下文时拒绝数据访问并抛出明确的异常
- **FR-010**: 模块必须支持多租户环境下的独立连接管理
- **FR-011**: 模块必须支持平台级数据（不属于任何租户）的访问控制

#### 事务管理

- **FR-012**: 模块必须提供声明式事务支持（如通过装饰器）
- **FR-013**: 模块必须提供编程式事务支持（手动开始、提交、回滚）
- **FR-014**: 模块必须在事务执行成功时自动提交所有操作
- **FR-015**: 模块必须在事务执行失败时自动回滚所有操作
- **FR-016**: 模块必须使用数据库的默认事务隔离级别，不提供应用层配置选项（简化配置，减少错误风险）
- **FR-017**: 模块必须支持嵌套事务或保存点（savepoint）机制

#### 连接池管理

- **FR-018**: 模块必须支持连接池配置（最小连接数、最大连接数、空闲超时等）
- **FR-019**: 模块必须在连接池满时合理处理新的连接请求（排队或拒绝）
- **FR-020**: 模块必须自动回收空闲超时的连接
- **FR-021**: 模块必须自动检测并移除不健康的连接
- **FR-022**: 模块必须在应用关闭时优雅地关闭所有连接

#### 监控和健康检查

- **FR-023**: 模块必须提供健康检查接口，返回数据库连接状态
- **FR-024**: 模块必须记录慢查询（执行时间超过配置阈值的查询）
- **FR-025**: 模块必须提供连接池统计信息（活动连接数、空闲连接数、等待请求数等）
- **FR-026**: 模块必须提供查询性能统计（平均执行时间、查询次数等）
- **FR-027**: 模块必须在多租户环境下提供每个租户的独立统计数据

#### 异常处理

- **FR-028**: 模块必须使用 @hl8/exceptions 提供的标准异常类型
- **FR-029**: 模块必须为不同的错误场景提供专用异常类型（连接异常、查询异常、事务异常等）
- **FR-030**: 模块必须在异常中包含足够的上下文信息（如租户 ID、查询 SQL、错误原因等）
- **FR-031**: 模块必须遵循 RFC7807 标准的错误响应格式

#### 配置管理

- **FR-032**: 模块必须使用 @hl8/config 进行配置管理
- **FR-033**: 模块必须支持类型安全的配置验证
- **FR-034**: 模块必须支持从环境变量加载配置
- **FR-035**: 模块必须为所有配置项提供合理的默认值

#### 模块兼容性

- **FR-036**: 模块必须使用 ES Module 格式（type: "module"）
- **FR-037**: 模块必须将构建产物输出到 dist/ 目录
- **FR-038**: 模块必须提供完整的 TypeScript 类型定义
- **FR-039**: 模块必须与现有基础设施库兼容（@hl8/config、@hl8/exceptions、@hl8/nestjs-isolation、@hl8/caching）

### Key Entities

- **DatabaseConnection**: 代表与数据库的物理连接，包含连接状态、连接参数、健康状态等属性
- **IsolationContext**: 来自 @hl8/isolation-model，代表当前请求的数据隔离上下文，包含平台 ID、租户 ID、组织 ID、部门 ID、用户 ID
- **Transaction**: 代表一个数据库事务，包含事务状态（进行中、已提交、已回滚）、隔离级别、关联的连接
- **ConnectionPool**: 代表连接池，包含活动连接列表、空闲连接列表、配置参数（最大/最小连接数、超时时间）
- **QueryMetrics**: 代表查询性能指标，包含查询 SQL、执行时间、执行次数、关联的隔离上下文

## Success Criteria _(mandatory)_

### Measurable Outcomes

- **SC-001**: 应用启动到数据库连接建立成功的时间在正常网络环境下不超过 5 秒
- **SC-002**: 在配置的连接池大小范围内，系统能够支持至少 1000 个并发数据库操作而不出现连接等待
- **SC-003**: 多租户环境下，100% 的数据访问请求都能正确应用隔离上下文，无跨租户数据泄露
- **SC-004**: 事务失败时，100% 的情况下都能正确回滚所有操作，无数据不一致
- **SC-005**: 慢查询（执行时间 > 1秒）能够在 1 分钟内被记录并通过监控接口查询到
- **SC-006**: 健康检查接口响应时间不超过 100 毫秒
- **SC-007**: 所有数据库连接相关的错误都能够被正确捕获并转换为符合 RFC7807 标准的异常响应
- **SC-008**: 模块的所有公共 API 都具有完整的 TypeScript 类型定义，开发者可以获得完整的 IDE 智能提示
- **SC-009**: 95% 的常见配置错误（如错误的连接参数、缺失的环境变量）能够在应用启动时被检测并提供清晰的错误提示

## Assumptions

以下假设在编写此规范时被采用：

1. **数据库类型**: 假设主要支持 PostgreSQL，MongoDB 支持作为可选扩展
2. **ORM 选择**: 假设使用 MikroORM 作为底层 ORM，因为旧代码基于此构建
3. **事务隔离级别**: 使用数据库的默认隔离级别（PostgreSQL 为 READ COMMITTED），不在应用层提供配置选项以简化使用并减少配置错误
4. **连接池默认值**: 假设默认最小连接数为 5，最大连接数为 20，空闲超时为 10 分钟
5. **慢查询阈值**: 假设默认慢查询阈值为 1000 毫秒
6. **日志方案**: 使用 @hl8/nestjs-fastify 提供的 FastifyLoggerService（全局统一的日志服务，自动包含隔离上下文，零开销高性能）
7. **数据库迁移**: 本模块不提供迁移功能，数据库 schema 变更由独立的迁移项目负责
8. **认证方式**: 假设使用传统的用户名/密码认证连接数据库，SSL/TLS 连接作为可选配置
9. **重连策略**: 假设在连接失败时使用指数退避算法重试，最多重试 5 次
10. **租户连接管理**: 假设每个租户共享同一个连接池，而不是为每个租户创建独立连接池（除非配置了数据库级隔离）

## Out of Scope

以下功能明确不在本次实现范围内：

1. **数据库迁移**: 数据库 schema 变更管理（由独立的迁移项目负责）
2. **读写分离**: 主从数据库架构的读写分离功能
3. **分布式事务**: 跨多个数据库的分布式事务支持
4. **数据库集群管理**: 自动故障转移、负载均衡等集群管理功能
5. **持久化缓存**: 数据库查询结果缓存、连接信息缓存等（由 @hl8/caching 模块负责）。本模块仅维护必要的内存数据（如连接池统计、最近慢查询队列），不实现 Redis 缓存或其他持久化缓存机制
6. **数据库备份恢复**: 数据库的备份和恢复功能
7. **多数据库支持**: 同时连接多个不同类型的数据库
8. **数据加密**: 数据库级别的字段加密（应由应用层处理）
9. **审计日志**: 详细的数据变更审计日志（应由独立的审计模块处理）
10. **图形化管理界面**: 数据库管理的 Web UI

## Dependencies

- **@hl8/nestjs-fastify**: Fastify 基础设施（日志服务）
- **@hl8/config**: 配置管理
- **@hl8/exceptions**: 异常处理
- **@hl8/nestjs-isolation**: 多租户数据隔离
- **@hl8/isolation-model**: 隔离上下文领域模型
- **@nestjs/common**: NestJS 核心模块
- **@nestjs/core**: NestJS 核心功能
- **@mikro-orm/core**: ORM 核心库
- **@mikro-orm/nestjs**: MikroORM 的 NestJS 集成
- **@mikro-orm/postgresql**: PostgreSQL 驱动
- **nestjs-cls**: 上下文本地存储，用于传递隔离上下文
- **class-transformer**: 类型转换
- **class-validator**: 配置验证

## Next Steps

1. ✅ 所有需求已明确，无待澄清问题
2. 使用 `/speckit.plan` 创建详细的实现计划
3. 开始实现 P1 优先级的用户故事（应用启动建立数据库连接）
