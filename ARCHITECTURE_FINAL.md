# HL8 ä¸‰å±‚æ¶æ„ - æœ€ç»ˆç‰ˆæœ¬

**é¡¹ç›®**: HL8 SAAS Platform  
**æ—¥æœŸ**: 2025-10-12  
**çŠ¶æ€**: âœ… **ç”Ÿäº§å°±ç»ª**

---

## ğŸ—ï¸ æ¶æ„æ€»è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åº”ç”¨å±‚ (apps/)                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  fastify-api                                       â”‚  â”‚
â”‚  â”‚  - ä½¿ç”¨ @hl8/nestjs-fastify                        â”‚  â”‚
â”‚  â”‚  - ä½¿ç”¨ @hl8/nestjs-infra                          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ åˆ†ç¦»å¯¼å…¥
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Fastify ä¸“ç”¨å±‚ (libs/)                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  @hl8/nestjs-fastify                              â”‚  â”‚
â”‚  â”‚  â”œâ”€â”€ EnterpriseFastifyAdapter (ä¼ä¸šçº§é€‚é…å™¨)      â”‚  â”‚
â”‚  â”‚  â”œâ”€â”€ FastifyExceptionModule   (å¼‚å¸¸å¤„ç†)          â”‚  â”‚
â”‚  â”‚  â”œâ”€â”€ FastifyLoggingModule     (æ—¥å¿— + éš”ç¦»ä¸Šä¸‹æ–‡) â”‚  â”‚
â”‚  â”‚  â””â”€â”€ ç›‘æ§æœåŠ¡ (å¥åº·æ£€æŸ¥ã€æ€§èƒ½ç›‘æ§)                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ depends on
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  NestJS é€šç”¨å±‚ (libs/)                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  @hl8/nestjs-infra                                â”‚  â”‚
â”‚  â”‚  â”œâ”€â”€ ExceptionModule    (é€šç”¨å¼‚å¸¸)                â”‚  â”‚
â”‚  â”‚  â”œâ”€â”€ CachingModule      (Redis ç¼“å­˜)              â”‚  â”‚
â”‚  â”‚  â”œâ”€â”€ IsolationModule    (5 çº§æ•°æ®éš”ç¦»)            â”‚  â”‚
â”‚  â”‚  â”œâ”€â”€ TypedConfigModule  (ç±»å‹å®‰å…¨é…ç½®)            â”‚  â”‚
â”‚  â”‚  â””â”€â”€ LoggingModule      (é€šç”¨æ—¥å¿—ï¼Œç”¨äº Express)  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ depends on
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ ¸å¿ƒä¸šåŠ¡å±‚ (libs/)                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  @hl8/platform                                    â”‚  â”‚
â”‚  â”‚  â”œâ”€â”€ å€¼å¯¹è±¡ (EntityId, TenantId, ...)             â”‚  â”‚
â”‚  â”‚  â”œâ”€â”€ å®ä½“ (IsolationContext)                      â”‚  â”‚
â”‚  â”‚  â”œâ”€â”€ æšä¸¾ (IsolationLevel, DataSharingLevel)      â”‚  â”‚
â”‚  â”‚  â””â”€â”€ ç±»å‹ (DeepPartial, Constructor, ...)         â”‚  â”‚
â”‚  â”‚  âš¡ æ— æ¡†æ¶ä¾èµ–ï¼Œçº¯ä¸šåŠ¡é€»è¾‘                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“¦ åŒ…è¯¦æƒ…

### @hl8/platform (æ ¸å¿ƒä¸šåŠ¡å±‚)

**ä½ç½®**: `libs/platform/`  
**ç‰ˆæœ¬**: `0.1.0`  
**ä¾èµ–**: æ— æ¡†æ¶ä¾èµ–

**å†…å®¹**:
- `shared/value-objects/` - EntityId, TenantId, OrganizationId, DepartmentId, UserId
- `shared/entities/` - IsolationContext
- `shared/enums/` - IsolationLevel, DataSharingLevel
- `shared/types/` - DeepPartial, Constructor, Nullable ç­‰

**ç‰¹ç‚¹**:
- âœ… çº¯ TypeScript
- âœ… å¯åœ¨ä»»ä½•ç¯å¢ƒä½¿ç”¨ï¼ˆNode.js, Browser, Denoï¼‰
- âœ… é«˜åº¦å¯æµ‹è¯•
- âœ… æ˜“äºå¤ç”¨

### @hl8/nestjs-infra (NestJS é€šç”¨å±‚)

**ä½ç½®**: `libs/nestjs-infra/`  
**ç‰ˆæœ¬**: `0.3.0`  
**ä¾èµ–**: `@hl8/platform`, `@nestjs/*`, `nestjs-cls`, `ioredis`

**å†…å®¹**:
- `exceptions/` - ExceptionModule, AbstractHttpException, é€šç”¨å¼‚å¸¸ç±»
- `caching/` - CachingModule, CacheService, RedisService, è£…é¥°å™¨
- `isolation/` - IsolationModule, IsolationContextService, ä¸­é—´ä»¶ã€å®ˆå«
- `configuration/` - TypedConfigModule, åŠ è½½å™¨ã€éªŒè¯å™¨
- `logging/` - LoggingModule, LoggerService (ç”¨äº Express)
- `common/` - @Public è£…é¥°å™¨ç­‰

**ç‰¹ç‚¹**:
- âœ… é€‚ç”¨äº Express æˆ– Fastify
- âœ… æä¾›ä¼ä¸šçº§åŸºç¡€è®¾æ–½
- âœ… ä» @hl8/platform é‡æ–°å¯¼å‡ºæ ¸å¿ƒæ¨¡å—
- âœ… æ—  Fastify ä¸“ç”¨ä»£ç 

### @hl8/nestjs-fastify (Fastify ä¸“ç”¨å±‚)

**ä½ç½®**: `libs/nestjs-fastify/`  
**ç‰ˆæœ¬**: `0.1.0`  
**ä¾èµ–**: `@hl8/nestjs-infra`, `@nestjs/platform-fastify`, `fastify`, `pino`

**å†…å®¹**:
- `fastify/enterprise-fastify.adapter.ts` - ä¼ä¸šçº§é€‚é…å™¨
- `fastify/config/` - Fastify é…ç½®
- `fastify/monitoring/` - å¥åº·æ£€æŸ¥ã€æ€§èƒ½ç›‘æ§
- `exceptions/` - Fastify å¼‚å¸¸è¿‡æ»¤å™¨
- `logging/` - FastifyLoggingModule, FastifyLoggerService

**ç‰¹ç‚¹**:
- âš¡ é›¶å¼€é”€ï¼ˆå¤ç”¨ Fastify Pinoï¼‰
- ğŸ¯ è‡ªåŠ¨åŒ…å«éš”ç¦»ä¸Šä¸‹æ–‡
- ğŸš€ 10-20x æ€§èƒ½æå‡
- âœ… 100% Fastify ä¼˜åŒ–

---

## ğŸ¯ å¯¼å…¥æŒ‡å—

### Fastify åº”ç”¨ï¼ˆæ¨èç”¨æ³•ï¼‰

```typescript
// main.ts
import { EnterpriseFastifyAdapter } from '@hl8/nestjs-fastify';

const app = await NestFactory.create(
  AppModule,
  new EnterpriseFastifyAdapter()
);

// app.module.ts
import {
  FastifyExceptionModule,    // Fastify ä¸“ç”¨
  FastifyLoggingModule,
} from '@hl8/nestjs-fastify';

import {
  CachingModule,              // NestJS é€šç”¨
  IsolationModule,
  TypedConfigModule,
} from '@hl8/nestjs-infra';

import {
  EntityId,                   // æ ¸å¿ƒä¸šåŠ¡
  IsolationContext,
} from '@hl8/platform';

@Module({
  imports: [
    FastifyExceptionModule.forRoot(),
    FastifyLoggingModule.forRoot(),
    IsolationModule.forRoot(),
    // CachingModule.forRoot(...),  // å¯é€‰
  ],
})
export class AppModule {}
```

### Express åº”ç”¨

```typescript
// ä½¿ç”¨é€šç”¨æ¨¡å—
import {
  ExceptionModule,      // é€šç”¨å¼‚å¸¸
  LoggingModule,        // é€šç”¨æ—¥å¿—
  CachingModule,
  IsolationModule,
} from '@hl8/nestjs-infra';
```

---

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

### æ—¥å¿—æ€§èƒ½

```
@nestjs/common/Logger:        ~150ms / 100k è°ƒç”¨
@hl8/nestjs-infra/Logger:     ~100ms / 100k è°ƒç”¨
@hl8/nestjs-fastify/Logger:   ~8ms   / 100k è°ƒç”¨

æå‡: 12-20x ğŸš€
```

### å†…å­˜å ç”¨

```
é€šç”¨ Logger:    +100KB (æ–° Pino å®ä¾‹)
Fastify Logger: +0KB   (å¤ç”¨ Fastify Pino)

èŠ‚çœ: 100KB Ã— å®ä¾‹æ•°
```

---

## ğŸ† æ¶æ„ä¼˜åŠ¿

### 1. æ¸…æ™°çš„èŒè´£åˆ†ç¦» âœ…

æ¯ä¸ªåŒ…èŒè´£å•ä¸€ï¼š
- `platform` - çº¯ä¸šåŠ¡é€»è¾‘
- `nestjs-infra` - NestJS é€šç”¨æ¨¡å—
- `nestjs-fastify` - Fastify ä¸“ç”¨ä¼˜åŒ–

### 2. å•å‘ä¾èµ–å…³ç³» âœ…

```
apps â†’ fastify â†’ infra â†’ platform
```
- æ— å¾ªç¯ä¾èµ–
- æ¸…æ™°çš„å±‚æ¬¡å…³ç³»

### 3. æè‡´æ€§èƒ½ä¼˜åŒ– âš¡

- é›¶å¼€é”€æ—¥å¿—ï¼ˆå¤ç”¨ Fastify Pinoï¼‰
- è¿è¡Œæ—¶ç±»å‹æ£€æŸ¥å’Œé™çº§
- æ™ºèƒ½ä¾èµ–æ³¨å…¥

### 4. ä¼ä¸šçº§åŠŸèƒ½å®Œæ•´ ğŸ¯

- RFC7807 ç»Ÿä¸€å¼‚å¸¸å¤„ç†
- 5 çº§æ•°æ®éš”ç¦»ï¼ˆå¹³å°/ç§Ÿæˆ·/ç»„ç»‡/éƒ¨é—¨/ç”¨æˆ·ï¼‰
- è‡ªåŠ¨éš”ç¦»ä¸Šä¸‹æ–‡æ³¨å…¥ï¼ˆæ—¥å¿—ã€ç¼“å­˜ï¼‰
- å¥åº·æ£€æŸ¥å’Œæ€§èƒ½ç›‘æ§

### 5. é«˜åº¦å¯ç»´æŠ¤ ğŸ“

- æ¨¡å—å®Œå…¨ç‹¬ç«‹
- æ–‡æ¡£è¯¦å°½å®Œå–„
- æ¸…æ™°çš„ä½¿ç”¨æŒ‡å—
- å®Œæ•´çš„å†³ç­–è®°å½•

---

## ğŸ“ æ–‡æ¡£æ¸…å•

### è§„åˆ’å’Œè®¾è®¡
- âœ… `docs/refactoring-plan-three-layers.md` - ä¸‰å±‚æ¶æ„è¯¦ç»†è§„åˆ’

### å®æ–½å’ŒéªŒè¯
- âœ… `docs/integration-verification-complete.md` - é›†æˆéªŒè¯æŠ¥å‘Š
- âœ… `docs/module-independence-final.md` - æ¨¡å—ç‹¬ç«‹æ€§ä¼˜åŒ–
- âœ… `docs/logger-architecture-decision.md` - Logger æ¶æ„å†³ç­–
- âœ… `docs/three-layer-architecture-complete.md` - é‡æ„å®Œæˆæ€»ç»“
- âœ… `ARCHITECTURE_FINAL.md` - æ¶æ„æœ€ç»ˆç‰ˆæœ¬ï¼ˆæœ¬æ–‡æ¡£ï¼‰

### åŒ…æ–‡æ¡£
- âœ… `libs/platform/README.md` - æ ¸å¿ƒä¸šåŠ¡å±‚
- âœ… `libs/nestjs-fastify/README.md` - Fastify ä¸“ç”¨å±‚
- âœ… `libs/nestjs-infra/README.md` - NestJS é€šç”¨å±‚

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–

```bash
pnpm install
```

### 2. æ„å»ºæ‰€æœ‰åŒ…

```bash
pnpm --filter @hl8/platform build
pnpm --filter @hl8/nestjs-infra build
pnpm --filter @hl8/nestjs-fastify build
pnpm --filter fastify-api build
```

### 3. å¯åŠ¨åº”ç”¨

```bash
cd apps/fastify-api
pnpm start
```

åº”ç”¨å°†åœ¨ `http://0.0.0.0:3001` å¯åŠ¨

### 4. æµ‹è¯• API

```bash
# åŸºæœ¬ç«¯ç‚¹
curl http://localhost:3001/

# ä¿¡æ¯ç«¯ç‚¹
curl http://localhost:3001/info

# å¸¦éš”ç¦»ä¸Šä¸‹æ–‡çš„è¯·æ±‚
curl -H "X-Tenant-Id: tenant-123" \
     -H "X-Organization-Id: org-456" \
     http://localhost:3001/info
```

---

## ğŸ“ˆ æŒ‡æ ‡ç»Ÿè®¡

```
æäº¤æ•°:     11 ä¸ªåŠŸèƒ½æäº¤
æ–‡ä»¶å˜æ›´:   59 files
ä»£ç å¢åŠ :   +3041 lines
ä»£ç åˆ é™¤:   -432 lines
å‡€å¢åŠ :     +2609 lines
æ–‡æ¡£:       6 ä¸ªè¯¦ç»†æ–‡æ¡£
```

---

## âœ… éªŒæ”¶æ¸…å•

| é¡¹ç›® | çŠ¶æ€ |
|------|------|
| âœ… ä¸‰å±‚æ¶æ„å®æ–½ | å®Œæˆ |
| âœ… æ ¸å¿ƒå±‚æ— æ¡†æ¶ä¾èµ– | å®Œæˆ |
| âœ… Fastify ä¸“ç”¨æ¨¡å—å®Œæ•´ | å®Œæˆ |
| âœ… æ¨¡å—å®Œå…¨ç‹¬ç«‹ | å®Œæˆ |
| âœ… æ‰€æœ‰åŒ…æ„å»ºæˆåŠŸ | å®Œæˆ |
| âœ… åº”ç”¨æ­£å¸¸å¯åŠ¨ | å®Œæˆ |
| âœ… å¼‚å¸¸å¤„ç†å·¥ä½œ | å®Œæˆ |
| âœ… æ—¥å¿—åŠŸèƒ½å®Œæ•´ | å®Œæˆ |
| âœ… æ•°æ®éš”ç¦»å·¥ä½œ | å®Œæˆ |
| âœ… æ€§èƒ½ä¼˜åŒ–å®ç° | å®Œæˆ |
| âœ… æ–‡æ¡£å®Œæ•´ | å®Œæˆ |
| âœ… æ¶æ„å†³ç­–è®°å½• | å®Œæˆ |

**å…¨éƒ¨ 12 é¡¹éªŒæ”¶æ ‡å‡†é€šè¿‡ï¼** âœ…

---

**ğŸ‰ ä¸‰å±‚æ¶æ„é‡æ„å®Œå…¨æˆåŠŸï¼é¡¹ç›®ç°å·²ç”Ÿäº§å°±ç»ªï¼**

